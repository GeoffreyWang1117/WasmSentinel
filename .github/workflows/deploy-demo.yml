name: Deploy Demo Website to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'demo-website/**'
      - 'README.md'
      - 'TEST_REPORT.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 构建作业
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create pages directory
        run: |
          mkdir -p _site
          
      - name: Copy demo website
        run: |
          cp -r demo-website/* _site/
          
      - name: Copy documentation
        run: |
          mkdir -p _site/docs
          cp README.md _site/docs/
          cp TEST_REPORT.md _site/docs/
          
          # 如果存在docs目录，复制其内容
          if [ -d "docs" ]; then
            cp -r docs/* _site/docs/
          fi
          
      - name: Generate API documentation
        run: |
          # 创建API文档
          mkdir -p _site/api
          
          cat > _site/api/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API文档 - WASM-ThreatDetector</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
              <style>
                  body { background: #1f2937; color: #f9fafb; }
                  .api-endpoint { background: rgba(255,255,255,0.05); padding: 1rem; margin: 1rem 0; border-radius: 8px; }
                  .method-get { border-left: 4px solid #10b981; }
                  .method-post { border-left: 4px solid #3b82f6; }
                  .method-delete { border-left: 4px solid #ef4444; }
              </style>
          </head>
          <body>
              <div class="container mt-5">
                  <h1>API 文档</h1>
                  
                  <div class="api-endpoint method-get">
                      <h3>GET /health</h3>
                      <p>健康检查端点，返回服务状态</p>
                      <pre><code>curl http://localhost:8080/health</code></pre>
                  </div>
                  
                  <div class="api-endpoint method-get">
                      <h3>GET /metrics</h3>
                      <p>Prometheus指标端点</p>
                      <pre><code>curl http://localhost:8080/metrics</code></pre>
                  </div>
                  
                  <div class="api-endpoint method-get">
                      <h3>GET /api/rules</h3>
                      <p>获取已加载的检测规则列表</p>
                      <pre><code>curl http://localhost:8080/api/rules</code></pre>
                  </div>
                  
                  <div class="api-endpoint method-get">
                      <h3>GET /api/events/stream</h3>
                      <p>实时威胁事件流（SSE）</p>
                      <pre><code>curl http://localhost:8080/api/events/stream</code></pre>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Generate sitemap
        run: |
          cat > _site/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://your-username.github.io/WASM-ThreatDetector/</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>https://your-username.github.io/WASM-ThreatDetector/docs/quickstart.html</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <priority>0.8</priority>
            </url>
            <url>
              <loc>https://your-username.github.io/WASM-ThreatDetector/api/</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <priority>0.6</priority>
            </url>
          </urlset>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # 部署作业
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
